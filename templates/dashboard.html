<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Guest Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
        table { border-collapse: collapse; width: 100%; background: #fff; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
        th { background-color: #007BFF; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .expired { color: red; }
        .active { color: green; }
    </style>
</head>
<body>
    <h1>Guest Dashboard</h1>
    <table>
        <thead>
            <tr>
                <th>Email</th>
                <th>Voucher Code</th>
                <th>Plan</th>
                <th>Status</th>
                <th>Expires At</th>
            </tr>
        </thead>
        <tbody>
        {% for guest in guests %}
            <tr class="{{ 'expired' if guest.status == 'Expired' else 'active' }}">
                <td>{{ guest.email }}</td>
                <td>{{ guest.voucher_code }}</td>
                <td>{{ guest.plan }}</td>
                <td>{{ guest.status }}</td>
                <td>{{ guest.expires_at }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</body>
</html>
<tbody>
{% for guest in guests %}
<tr class="{{ 'expired' if guest.status == 'Expired' else 'active' }}">
    <td>{{ guest.email }}</td>
    <td>{{ guest.voucher_code }}</td>
    <td>{{ guest.plan }}</td>
    <td>{{ guest.status }}</td>
    <td>{{ guest.expires_at }}</td>
    <td>
        {% if guest.status == 'Active' %}
        <form method="POST" action="/extend_access">
            <input type="hidden" name="email" value="{{ guest.email }}">
            <input type="number" name="extra_hours" placeholder="Hours" min="1" required>
            <button type="submit">Extend</button>
        </form>
        {% else %}
        N/A
        {% endif %}
    </td>
</tr>
{% endfor %}
</tbody>
<td>
    {% if guest.status == 'Active' %}
    <form method="POST" action="/extend_access" style="display:inline-block;">
        <input type="hidden" name="email" value="{{ guest.email }}">
        <input type="number" name="extra_hours" placeholder="Hours" min="1" required>
        <button type="submit">Extend</button>
    </form>
    <form method="POST" action="/revoke_access" style="display:inline-block;">
        <input type="hidden" name="email" value="{{ guest.email }}">
        <button type="submit" style="background:red;color:white;">Revoke</button>
    </form>
    {% else %}
    N/A
    {% endif %}
</td>
<script>
async function refreshGuests() {
    const response = await fetch("/guests_data");
    const data = await response.json();

    const tbody = document.querySelector("tbody");
    tbody.innerHTML = "";

    data.forEach(guest => {
        const tr = document.createElement("tr");
        tr.className = guest.status === "Expired" ? "expired" :
                       guest.status === "Revoked" ? "revoked" : "active";

        tr.innerHTML = `
            <td>${guest.email}</td>
            <td>${guest.voucher_code}</td>
            <td>${guest.plan}</td>
            <td>${guest.status}</td>
            <td>${guest.expires_at}</td>
            <td>
                ${guest.status === 'Active' ? `
                <form method="POST" action="/extend_access" style="display:inline-block;">
                    <input type="hidden" name="email" value="${guest.email}">
                    <input type="number" name="extra_hours" placeholder="Hours" min="1" required>
                    <button type="submit">Extend</button>
                </form>
                <form method="POST" action="/revoke_access" style="display:inline-block;">
                    <input type="hidden" name="email" value="${guest.email}">
                    <button type="submit" style="background:red;color:white;">Revoke</button>
                </form>` : "N/A"}
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Refresh every 10 seconds
setInterval(refreshGuests, 10000);
window.onload = refreshGuests;
</script>
<h2>Analytics</h2>
<div style="width: 80%; margin-bottom: 30px;">
    <canvas id="statusChart"></canvas>
</div>
<div style="width: 80%; margin-bottom: 30px;">
    <canvas id="planChart"></canvas>
</div>
<script>
let statusChart, planChart;

async function updateCharts() {
    const response = await fetch("/guests_data");
    const data = await response.json();

    // Count statuses
    const statuses = { Active: 0, Expired: 0, Revoked: 0 };
    const plans = {};
    let revenuePerPlan = {};

    data.forEach(guest => {
        statuses[guest.status] = (statuses[guest.status] || 0) + 1;
        plans[guest.plan] = (plans[guest.plan] || 0) + 1;
        revenuePerPlan[guest.plan] = (revenuePerPlan[guest.plan] || 0) + parseFloat(guest.voucher_code.split("-")[1]);
    });

    // Status Chart
    if (statusChart) statusChart.destroy();
    const ctx1 = document.getElementById("statusChart").getContext("2d");
    statusChart = new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: Object.keys(statuses),
            datasets: [{
                label: 'Guest Status',
                data: Object.values(statuses),
                backgroundColor: ['#28a745', '#dc3545', '#fd7e14']
            }]
        }
    });

    // Plan Chart
    if (planChart) planChart.destroy();
    const ctx2 = document.getElementById("planChart").getContext("2d");
    planChart = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: Object.keys(plans),
            datasets: [{
                label: 'Number of Guests per Plan',
                data: Object.values(plans),
                backgroundColor: '#007bff'
            }]
        },
        options: { responsive: true }
    });
}

// Call updateCharts every 10 seconds along with refreshGuests
setInterval(() => { refreshGuests(); updateCharts(); }, 10000);
window.onload = () => { refreshGuests(); updateCharts(); };
</script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
